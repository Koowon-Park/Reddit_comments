<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>kg</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="KG_files/libs/clipboard/clipboard.min.js"></script>
<script src="KG_files/libs/quarto-html/quarto.js"></script>
<script src="KG_files/libs/quarto-html/popper.min.js"></script>
<script src="KG_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="KG_files/libs/quarto-html/anchor.min.js"></script>
<link href="KG_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="KG_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="KG_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="KG_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="KG_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="knowledge-graphs" class="level1">
<h1>Knowledge Graphs</h1>
<p>Knowledge Graphs (KGs) provide a robust framework for representing, managing, and analyzing complex relationships between entities. They serve as valuable tools for uncovering patterns and gaining insights from interconnected datasets, such as Reddit discussions.</p>
<section id="neo4j" class="level2">
<h2 class="anchored" data-anchor-id="neo4j">Neo4j</h2>
<p>The initial construction of our Knowledge Graph was implemented in Neo4j. In this representation, we categorized the nodes as follows: authors in blue, comments in pink, themes in green, scores in orange, and sentiment in red.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/graph.png" class="img-fluid figure-img"></p>
<figcaption>Graph Image</figcaption>
</figure>
</div>
<p>As we increase the complexity of the graph by incorporating additional nodes and relationships, the relationships between different entities become more evident.</p>
<p><img src=".\images/clipboard-583397259.png" class="img-fluid"></p>
<p>Further complexity reveals richer insights but also introduces challenges in interpreting the data visually.</p>
<p><img src="../images/clipboard-747420762.png" class="img-fluid"></p>
</section>
<section id="gephi" class="level2">
<h2 class="anchored" data-anchor-id="gephi">Gephi</h2>
<p>As the complexity increase neo4j becomes really non efficient so we can use Gephi to visualize the graph.</p>
<section id="openord" class="level3">
<h3 class="anchored" data-anchor-id="openord">OpenOrd</h3>
<p>Openord is a force-directed layout algorithm that is based on stress minimization. It is a good choice for large graphs.</p>
<p><img src="../../images/gephi1_openord.png" class="img-fluid"></p>
<p>We can ovserve here that the graph is really complex and hard to interpret.</p>
<p><img src="../../images/clipboard-2332198561.png" class="img-fluid"></p>
<p>Adding the scores nodes in blue did not help to understand the graph.</p>
</section>
<section id="yifanhu" class="level3">
<h3 class="anchored" data-anchor-id="yifanhu">yifanHu</h3>
<p>YifanHu is a force-directed layout algorithm that is based on the physical model of the system.</p>
</section>
<section id="themes" class="level3">
<h3 class="anchored" data-anchor-id="themes">Themes</h3>
<p>Using YifanHu on gephi we can observe here an interesting representation of the prevalance of different theme in our dataset.</p>
<p><img src="../../images/clipboard-927049404.png" class="img-fluid" width="224"></p>
<p>We observe here that theme 9 which is about ‘Sports, Teams, and Player Discussions’ is the most prevalent for example.</p>
<p><img src="../../images/clipboard-2630725974.png" class="img-fluid"></p>
</section>
<section id="sentiment" class="level3">
<h3 class="anchored" data-anchor-id="sentiment">Sentiment</h3>
<p>adding sentiment in green (positive) and red (negative) complexifies the graph but can be useful to understand the sentiment of the different themes. We observe for example that theme 9 as a lot of ‘red’ which means that it is mostly negative compares to other themes.</p>
<p><img src="../../images/clipboard-3037199124.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check if theme 9 as indeed more negative sentiment</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>table_data <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(theme <span class="sc">==</span> <span class="dv">9</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sentiment_category) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the table using kable</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(table_data, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Sentiment Category"</span>, <span class="st">"Count"</span>), <span class="at">caption =</span> <span class="st">"Sentiment Category Counts for Theme 9"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#check if theme 9 as indeed more negative sentiment</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>table_data <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(theme <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sentiment_category) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the table using kable</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(table_data, <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Sentiment Category"</span>, <span class="st">"Count"</span>), <span class="at">caption =</span> <span class="st">"Sentiment Category Counts for Theme 9"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which is indeed verified.</p>
</section>
<section id="scores" class="level3">
<h3 class="anchored" data-anchor-id="scores">Scores</h3>
<p>the same can be done with score in shades of blue but it becomes a bit more complex to interpret.</p>
<p><img src="../../images/clipboard-688774298.png" class="img-fluid"></p>
<p>changer couleur sur valeur extreme seulement, plus lisible</p>
</section>
</section>
<section id="similarities" class="level2">
<h2 class="anchored" data-anchor-id="similarities">Similarities</h2>
<section id="author-theme" class="level3">
<h3 class="anchored" data-anchor-id="author-theme">Author-Theme</h3>
<p>They can also for example be used to understand similarities.</p>
<p>It was tried here to identifies connection through theme between authors with a similaritie score found through an THEME_AUTHORS relationship on NEO4J.</p>
<p><img src="../../images/clipboard-3780268986.png" class="img-fluid"></p>
<p>We observe that the small dots (authors) on the left side have a lots of connection through different theme nodes.</p>
<p><img src="../../images/clipboard-2533163853.png" class="img-fluid"></p>
<p>For example here we observe the relationship of authors based on theme 1, which correspond to ‘Rules, Information, and Wiki Communitie’ finds authors similarities between ‘Automoderator’, ‘Autowikibot’, ‘totes_meta_bot’, and other it seems like non bot authors like ‘timewaitsforsome’, ect. It seems logical that those authors are connected through the same theme.</p>
<p>Now if we isolate theme 17 which is about ‘Politics, Science, and Star Wars’.</p>
<p><img src="../../images/clipboard-1197459568.png" class="img-fluid"></p>
<p>rajouter texte dessus</p>
<p>We observe that still Automoderator and autowikibot are part of it as they have a relation in all theme which is logical. But we also observe now techrush andd beefat99 and tweetposter for example.</p>
<p>We can continue for other themes but you get the point that I want to demonstrate that we can play with those knowledge graph to get insights from it.</p>
</section>
</section>
<section id="subreddits" class="level2">
<h2 class="anchored" data-anchor-id="subreddits">Subreddits</h2>
<p>Subreddit Knowledge Graphs help visualize and analyze relationships between subreddits, uncovering meaningful connections and thematic clusters. In this section, we explore the relationships in a subset of our dataset, providing insights and observations.</p>
</section>
<section id="disclaimer" class="level2">
<h2 class="anchored" data-anchor-id="disclaimer">Disclaimer</h2>
<p>The data presented is a lighter subset (approximately 1/5 of the previous dataset) that includes only subreddits we successfully scraped, found descriptions for, and identified related subreddits. This smaller dataset was easier to compute and provides more interpretable results.</p>
<p>Not all subreddits list related subreddits on their pages. For example, two of the most commented subreddits (indicated by the black circles at the bottom right) are only related to each other.<br>
so the absence of a related subreddit for some subreddit does not diminish its importance in the graph.</p>
<p>To understand the graphs some nodes are colored to help understand the graph.</p>
<p>In the graph, the nodes are colored as follows: in blue are the subreddit with a score more than 4 (it allow us to see if some place in the graph have more high score subreddit than other) in red are the top 20 subreddit with the most comments (to see which subreddit are the most popular) in dark green are the top 20 subreddit who are the most related to other subreddit (subreddit who are the most connected to other subreddit)</p>
<p>Note that sometimes a subreddit can be in multiple categories.</p>
<p><img src="../../images/nodes.png" class="img-fluid"> <img src="../../images/full%20related%20graph.png" class="img-fluid"> ## Clusters and Insights ### Sports Cluster</p>
<p>A distinct <strong>sports cluster</strong> is visible, highlighting subreddits focused on athletic discussions and team-related themes.</p>
<p><img src="../../images/sport%20cluster.png" class="img-fluid"></p>
<section id="connections-between-themes" class="level3">
<h3 class="anchored" data-anchor-id="connections-between-themes">Connections Between Themes</h3>
<p>Some connections between seemingly unrelated topics are intriguing. For example, gardening and engineering are linked through <strong>biology</strong> and specifically <strong>mycology</strong>, with subreddits like “whatsthisplant” bridging these themes.</p>
<p><img src="../../images/gardening%20engineering.png" class="img-fluid"></p>
</section>
<section id="nintendo-cluster" class="level3">
<h3 class="anchored" data-anchor-id="nintendo-cluster">Nintendo Cluster</h3>
<p>The <strong>Nintendo cluster</strong> is another noteworthy group, bringing together subreddits focused on games like Zelda, Metroid, Pokémon, NES, and other Nintendo-related topics.</p>
<p><img src="../../images/nintendo.png" class="img-fluid"></p>
</section>
<section id="comicsmanga-cluster" class="level3">
<h3 class="anchored" data-anchor-id="comicsmanga-cluster">Comics/Manga Cluster</h3>
<p>A clear <strong>comics/manga cluster</strong> is also observed, demonstrating the grouping of subreddits around shared cultural interests.</p>
<p><img src="../../images/comics%20manga.png" class="img-fluid"></p>
</section>
<section id="observations" class="level3">
<h3 class="anchored" data-anchor-id="observations">Observations</h3>
<p>The connections between subreddits generally align with expectations, validating the graph’s representation of thematic relationships.<br>
Some subreddit themes are not perfectly classified due to reliance on automated methods, which explains the presence of many subreddits on the periphery of the graph. A manual classification approach might improve accuracy.</p>
</section>
</section>
<section id="subreddit-similarities" class="level2">
<h2 class="anchored" data-anchor-id="subreddit-similarities">Subreddit Similarities</h2>
<p>The following Cypher query, implemented in Neo4j, calculates similarity scores between subreddits by analyzing shared connections:</p>
<p>This query identifies and ranks related subreddits, providing insights into their relationships. We endup with this graph below : <img src="../../images/graph_teacher.png" class="img-fluid"><br>
As we can see we have a new way to represent the graph with their similarities.</p>
</section>
<section id="observations-of-similarities" class="level2">
<h2 class="anchored" data-anchor-id="observations-of-similarities">Observations of similarities</h2>
<p>The current dataset reveals clusters that are harder to interpret in the central region of the graph, but distinct thematic groups remain identifiable:</p>
<ul>
<li><strong>Sports Cluster</strong>: Located at the bottom, it showcases connections between athletic and sports-focused subreddits.</li>
</ul>
<p><img src="../../images/sports_bottom_cluster.png" class="img-fluid"></p>
<ul>
<li><strong>Cars/Racing Cluster</strong>: Found on the left, it groups subreddits centered on cars, motorsports, and racing.</li>
</ul>
<p><img src="../../images/cars_racing_cluster.png" class="img-fluid"></p>
<ul>
<li><p><strong>Gaming Cluster</strong>: Positioned at the top, this cluster aggregates gaming-related subreddits.</p>
<p><img src="../../images/gaming_cluster.png" class="img-fluid"></p></li>
<li><p><strong>Science and Communities Cluster</strong>: Slightly above and to the right, this cluster includes discussions about science, life advice, and community engagement.</p>
<p><img src="../../images/science_community_cluster.png" class="img-fluid"></p></li>
</ul>
<p>Conclusion: In this graph, the top related subreddits are more dispersed and less connected to the clusters compared to the previous graph. We knew that the top related subreddits are not always the most popular or those with the highest scores. It is also notable that some subreddits have no connections to others within the graph.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>